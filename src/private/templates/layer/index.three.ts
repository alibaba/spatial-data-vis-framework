// $REMOVE_START$
// eslint-disable-next-line @typescript-eslint/ban-ts-comment
// @ts-nocheck

/**
 * @note @warn DO NOT EDIT THIS FILE. IT IS TEMPLATE CODE.
 */
// $REMOVE_END$

/**
 * $LAYER_NAME$
 */
import { specifyNode } from '@gs.i/utils-specify'

import { StandardLayer, StandardLayerProps } from '@polaris.gl/gsi'

// three çš„åœºæ™¯æ ‘å…ƒç´ å’Œæ’ä»¶åŸºæœ¬éƒ½å¯ä»¥ä½¿ç”¨ï¼Œæ³¨æ„å¼•å…¥æ—¶é¿å…ç ´åè„æ£€æŸ¥
import { Group } from 'three'
import { Sky } from 'three/addons/objects/Sky.js'

import type { PropDescription } from '../../private/schema/meta'
import {
	DescToParsedType,
	DescToType,
	DescToTypeMutable,
	parseProps,
} from '../../private/utils/props'

export const info = {
	name: '',
	description: '',
	category: 'Unknown',
}

/**
 * è¯¦è§ @see {@link [PropDescription](../../private/schema/meta.ts)}
 *
 * Props Description. Used to:
 * - generate default props.
 * - check props type and range.
 * - generate the props editor UI.
 */
export const propsDesc = [
	// example: mutable prop
	{
		key: 'objectColor',
		name: 'objectColor',
		type: 'color',
		defaultValue: '#ffffff',
		mutable: true,
	},
	// example: immutable prop
	{
		name: 'lightColor',
		key: 'lightColor',
		type: 'color',
		defaultValue: '#ff0000',
	},
] as const

// @note type check. will be removed when compile.
propsDesc as readonly PropDescription[]

/**
 * $LAYER_NAME$ Props
 */
type $LAYER_NAME$Props = DescToType<typeof propsDesc>
type $LAYER_NAME$MutableProps = DescToTypeMutable<typeof propsDesc>

/**
 * factory function for $LAYER_NAME$
 *
 * @description å·¥å‚å‡½æ•°æ¨¡å¼è¯´æ˜
 *
 * @note å‡½æ•°å¼ç¼–ç¨‹
 * - propsDesc ä¸­çš„æ‰€æœ‰å±æ€§ï¼Œæ²¡æœ‰æŒ‡æ˜ mutable çš„ï¼Œé»˜è®¤éƒ½ä¸º immutable
 * - immutable å±æ€§å˜åŒ–ï¼Œä¼šé”€æ¯Layerï¼Œç„¶åç”¨å…¨æ–°çš„ props é‡æ–°æ‰§è¡Œå·¥å‚å‡½æ•°
 * - å·¥å‚å‡½æ•°æ— çŠ¶æ€ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡é—­åŒ…è‡ªè¡Œç¼“å­˜ä¸€äº›è®¡ç®—
 *
 * @legacy å…¼å®¹ç»å…¸çš„ç›‘å¬æ¨¡å¼
 * - å¦‚æœå¸Œæœ›æŸä¸ªå±æ€§å¯ä»¥è¿è¡Œæ—¶é¢‘ç¹å˜åŒ–
 * - - propsDesc ä¸­å°†å…¶æ ‡ä¸º `mutable: true`
 * - - é€šè¿‡ `layer.watchProps()` / `layer.watchProp()` ç›‘å¬å˜åŒ–å¹¶å“åº”
 */
export function create$LAYER_NAME$(props: $LAYER_NAME$Props) {
	console.log('create$LAYER_NAME$')

	// è¡¥å…¨ç¼ºçœå€¼ï¼Œå¹¶æ£€æŸ¥å¿…è¦æ€§ã€ç±»å‹å’Œå€¼èŒƒå›´
	const parsedProps = parseProps(props, propsDesc)

	const layer = new StandardLayer<StandardLayerProps & $LAYER_NAME$MutableProps>({
		name: '$LAYER_NAME$',
		...parsedProps,
	})

	/**
	 * three å†…å®¹å…¨éƒ¨æ”¾è¯¥ group ä¸‹
	 *
	 * è¯¥éƒ¨åˆ†å°† bypass GSI çš„è½¬æ¢é€»è¾‘ï¼Œç›´æ¥æ”¾åœ¨æœ€ç»ˆçš„ three åœºæ™¯æ ‘ä¸­ï¼Œç”± PolarisThree åˆ›å»º THREE.WebGLRenderer æ¸²æŸ“
	 *
	 * ## ğŸŒ ğŸ’ ğŸª `three in GSI` ä½¿ç”¨è¯´æ˜ ğŸ‘ˆ
	 *
	 * @experimental å®éªŒç‰¹æ€§ï¼Œè¯·å…³æ³¨åç»­æ›´æ–°
	 *
	 * @note ä»…éƒ¨åˆ† Polaris ç‰ˆæœ¬æ”¯æŒè¯¥ç‰¹æ€§
	 * @note å¦‚æœä¾èµ–ç‰¹å®šçš„ three ç‰ˆæœ¬ï¼Œå°†å¯¼è‡´æ— æ³•å‘åå…¼å®¹æˆ–åœ¨é¡¹ç›®é—´è¿ç§»
	 *
	 * @note ä¿®æ”¹ object3D çš„ transformï¼ˆposition/rotationç­‰ï¼‰åï¼Œéœ€è¦è°ƒç”¨ threeGroup.updateMatrixWorld(true) æ‰ä¼šç”Ÿæ•ˆ
	 * @note ä¸è¦ç”¨ Object3D.parent æˆ– updateWorldMatrix(true, true) ç­‰æ¥å£è¯»å–æˆ–æ“ä½œ threeGroup ä»¥å¤–çš„èŠ‚ç‚¹
	 * @note polaris ä¸ç®¡ç† threeå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¯·åœ¨ dispose äº‹ä»¶ä¸­ä½¿ç”¨ three æ¥å£ä¸»åŠ¨å›æ”¶å†…å­˜
	 *
	 */
	const threeGroup = new Group()

	// three object æ”¾å…¥ GSI åœºæ™¯æ ‘
	layer.group.add(
		specifyNode({
			name: 'gsi-three-linker',
			extensions: { EXT_ref_threejs: threeGroup },
		})
	)

	layer.addEventListener('init', async (e) => {
		const { projection, timeline, polaris } = e

		const threeRenderer = polaris['renderer'].renderer

		const sky = new Sky()
		sky.scale.setScalar(10000000000)
		threeGroup.add(sky)

		const skyUniforms = sky.material.uniforms

		skyUniforms['turbidity'].value = 10
		skyUniforms['rayleigh'].value = 2
		skyUniforms['mieCoefficient'].value = 0.005
		skyUniforms['mieDirectionalG'].value = 0.8
		const up = skyUniforms['up'].value
		up.y = 0
		up.z = 1

		threeGroup.updateMatrixWorld(true)

		layer.addEventListener('beforeRender', () => {
			threeGroup.updateMatrixWorld(true)
		})
	})

	return layer
}
